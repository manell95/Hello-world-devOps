name: Deploy Node.js to AWS

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
    
    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        if [ -f "package.json" ]; then
          npm install
          echo "‚úÖ Dependencies installed"
        else
          echo "‚ö†Ô∏è No package.json, skipping npm install"
        fi
    
    - name: Build application
      run: |
        echo "Building application..."
        if [ -f "package.json" ] && npm run build --if-present; then
          echo "‚úÖ Build completed"
        else
          echo "‚ö†Ô∏è No build script or no package.json"
        fi
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-1
    
    - name: Test AWS connection
      run: |
        echo "Testing AWS connection..."
        aws sts get-caller-identity
        echo "Listing S3 buckets:"
        aws s3 ls
    
    - name: Deploy to S3
      run: |
        echo "Deploying to S3..."
        
        # CHANGEZ LE NOM DE VOTRE BUCKET ICI
        BUCKET_NAME="votre-nom-bucket-unique"
        
        # D√©ployer selon la structure de votre projet
        if [ -d "dist" ]; then
          echo "üìÅ Deploying from dist/ folder..."
          aws s3 sync dist/ s3://$BUCKET_NAME --delete
        elif [ -d "build" ]; then
          echo "üìÅ Deploying from build/ folder..."
          aws s3 sync build/ s3://$BUCKET_NAME --delete
        else
          echo "üìÅ Deploying from root folder..."
          aws s3 sync . s3://$BUCKET_NAME \
            --delete \
            --exclude "node_modules/*" \
            --exclude ".git/*" \
            --exclude "*.md" \
            --exclude "package*.json" \
            --exclude ".github/*"
        fi
        
        echo "üéâ Deployment completed!"
        echo "üåê Your app should be available at:"
        echo "https://$BUCKET_NAME.s3-website.eu-west-1.amazonaws.com"
