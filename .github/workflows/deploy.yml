name: ğŸš€ Deploy Hello World DevOps

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Permet le dÃ©clenchement manuel

env:
  NODE_VERSION: '18'
  AWS_REGION: 'eu-west-1'

jobs:
  # Job de test et validation
  test:
    name: ğŸ§ª Tests & Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ğŸ“‹ Display environment info
      run: |
        echo "ğŸ” Environment Information"
        echo "========================="
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
        echo "OS: $(uname -a)"
        echo "Working directory: $(pwd)"
        ls -la
        echo "App directory contents:"
        ls -la app/
    
    - name: ğŸ“¦ Install dependencies
      run: |
        cd app
        npm install
    
    - name: ğŸ§ª Run tests
      run: |
        cd app
        npm test
    
    - name: ğŸ” Basic security scan
      run: |
        cd app
        npm audit --audit-level high || echo "âš ï¸ Security warnings found (non-blocking)"
    
    - name: ğŸ§ª Test application startup
      run: |
        cd app
        timeout 10s npm start || echo "âœ… Server startup test completed"

  # Job de build
  build:
    name: ğŸ—ï¸ Build
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ğŸ“¦ Install dependencies
      run: |
        cd app
        npm install --production
    
    - name: âœ… Verify application structure
      run: |
        cd app
        echo "âœ… Application structure verified"
        echo "ğŸ“‹ Files present:"
        ls -la
        echo "ğŸ“‹ Package.json scripts:"
        cat package.json | grep -A 10 "scripts"
    
    - name: ğŸ“¦ Create deployment artifact
      run: |
        tar -czf hello-world-app.tar.gz app/
        echo "âœ… Deployment artifact created"
        ls -la hello-world-app.tar.gz
    
    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: hello-world-build
        path: hello-world-app.tar.gz
        retention-days: 7

  # Job de dÃ©ploiement (seulement sur main/master)
  deploy:
    name: ğŸš€ Deploy to AWS
    needs: [test, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: âœ… Verify AWS connection
      run: |
        echo "ğŸ” Testing AWS connection..."
        aws sts get-caller-identity
        echo "âœ… AWS connection successful"
    
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: hello-world-build
    
    - name: ğŸ” Check existing instances
      id: check_instances
      run: |
        echo "ğŸ” Checking for existing Hello World instances..."
        EXISTING_INSTANCES=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=hello-world-devops" \
                    "Name=instance-state-name,Values=running,pending" \
          --query 'Reservations[*].Instances[*].InstanceId' \
          --output text)
        
        if [ -n "$EXISTING_INSTANCES" ] && [ "$EXISTING_INSTANCES" != "None" ]; then
          echo "âš ï¸ Found existing instances: $EXISTING_INSTANCES"
          echo "existing_instances=$EXISTING_INSTANCES" >> $GITHUB_OUTPUT
        else
          echo "âœ… No existing instances found"
          echo "existing_instances=" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ›‘ Stop existing instances (if any)
      if: steps.check_instances.outputs.existing_instances != ''
      run: |
        echo "ğŸ›‘ Stopping existing instances..."
        aws ec2 terminate-instances --instance-ids ${{ steps.check_instances.outputs.existing_instances }}
        echo "â³ Waiting for instances to terminate..."
        aws ec2 wait instance-terminated --instance-ids ${{ steps.check_instances.outputs.existing_instances }}
        echo "âœ… Existing instances terminated"
    
    - name: ğŸš€ Deploy new instance
      id: deploy
      run: |
        echo "ğŸš€ Deploying new Hello World DevOps instance..."
        
        # Rendre le script exÃ©cutable
        chmod +x scripts/deploy-to-aws.sh
        
        # ExÃ©cuter le dÃ©ploiement
        ./scripts/deploy-to-aws.sh
        
        # RÃ©cupÃ©rer l'ID de l'instance crÃ©Ã©e
        echo "ğŸ” Searching for new instance..."
        sleep 15
        
        INSTANCE_ID=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=hello-world-devops" \
                    "Name=instance-state-name,Values=running,pending" \
          --query 'Reservations[0].Instances[0].InstanceId' \
          --output text)
        
        if [ "$INSTANCE_ID" = "None" ] || [ -z "$INSTANCE_ID" ]; then
          echo "âŒ Could not find the deployed instance"
          exit 1
        fi
        
        # RÃ©cupÃ©rer l'IP publique
        PUBLIC_IP=$(aws ec2 describe-instances \
          --instance-ids $INSTANCE_ID \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
        echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
        
        echo "âœ… Deployment completed!"
        echo "ğŸ†” Instance ID: $INSTANCE_ID"
        echo "ğŸŒ Public IP: $PUBLIC_IP"
    
    - name: ğŸ“‹ Deployment summary
      run: |
        echo "ğŸ‰ DEPLOYMENT COMPLETED!"
        echo "======================="
        echo "ğŸ†” Instance ID: ${{ steps.deploy.outputs.instance_id }}"
        echo "ğŸŒ Public IP: ${{ steps.deploy.outputs.public_ip }}"
        echo "ğŸ”— Application URL: http://${{ steps.deploy.outputs.public_ip }}:3000"
        echo "ğŸ“… Deployment time: $(date)"
        echo "ğŸ”„ Triggered by: ${{ github.event_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo ""
        echo "â° The application is installing in the background"
        echo "ğŸ• Wait 5-10 minutes before accessing the URL"
        echo ""
        echo "ğŸ§ª Test manually: curl http://${{ steps.deploy.outputs.public_ip }}:3000/api/health"

  # Job de notification
  notify:
    name: ğŸ“¢ Notification
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¢ Deployment notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deployment successful!"
          echo "ğŸ”— Application: http://${{ needs.deploy.outputs.public_ip }}:3000"
        else
          echo "âŒ Deployment failed!"
        fi
