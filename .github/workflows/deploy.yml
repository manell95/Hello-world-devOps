name: Deploy Node.js to AWS

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: üì¶ Install dependencies
        run: |
          echo "Installing Node.js dependencies..."
          npm install
      
      - name: üß™ Run tests (if available)
        run: |
          echo "Running tests..."
          npm test --if-present
      
      - name: üî® Build application (if build script exists)
        run: |
          echo "Building application..."
          if npm run build --if-present; then
            echo "‚úÖ Build completed successfully"
            # V√©rifier ce qui a √©t√© cr√©√©
            if [ -d "dist" ]; then
              echo "üìÅ Contents of dist folder:"
              ls -la dist/
            elif [ -d "build" ]; then
              echo "üìÅ Contents of build folder:"
              ls -la build/
            else
              echo "üìÅ No dist/build folder, using root files"
              ls -la *.html *.css *.js 2>/dev/null || echo "No static files found"
            fi
          else
            echo "‚ÑπÔ∏è No build script found, deploying source files"
          fi
      
      - name: ‚öôÔ∏è Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1
      
      - name: üîç Test AWS connection
        run: |
          echo "Testing AWS connection..."
          aws sts get-caller-identity
          echo "Listing S3 buckets:"
          aws s3 ls
      
      - name: üöÄ Deploy to S3
        run: |
          echo "Deploying to S3..."
          
          # D√©finir le nom de votre bucket S3
          BUCKET_NAME="your-app-bucket-name"  # ‚ö†Ô∏è CHANGEZ CECI
          
          # D√©ployer selon la structure du projet
          if [ -d "dist" ]; then
            echo "Deploying from dist folder..."
            aws s3 sync dist/ s3://$BUCKET_NAME --delete
          elif [ -d "build" ]; then
            echo "Deploying from build folder..."
            aws s3 sync build/ s3://$BUCKET_NAME --delete
          else
            echo "Deploying static files from root..."
            aws s3 sync . s3://$BUCKET_NAME \
              --delete \
              --exclude "node_modules/*" \
              --exclude ".git/*" \
              --exclude "*.md" \
              --exclude "package*.json" \
              --exclude ".github/*"
          fi
          
          echo "üéâ Deployment completed!"
          echo "üåê Your site should be available at:"
          echo "https://$BUCKET_NAME.s3-website.eu-west-1.amazonaws.com"
      
      - name: ‚úÖ Success notification
        run: |
          echo "üéâ Deployment successful!"
          echo "üìä Deployment summary:"
          echo "- ‚úÖ Code checked out"
          echo "- ‚úÖ Node.js dependencies installed"
          echo "- ‚úÖ Application built (if applicable)"
          echo "- ‚úÖ Deployed to AWS S3"
